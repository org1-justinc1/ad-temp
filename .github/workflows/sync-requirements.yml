name: "Sync Requirements Files"

on:
    push:
        branches: [main]
        paths:
            - "requirements-pinned.txt"
    pull_request_target:
        paths:
            - "requirements-pinned.txt"

permissions:
  contents: write
  pull-requests: write

jobs:
    sync-requirements:
        runs-on: ubuntu-latest

        steps:
            - name: "Checkout automation-reports (${{ github.ref }}) - tested repo, PR"
              if: github.event_name == 'pull_request_target'
              uses: actions/checkout@v5
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  ref: ${{ github.event.pull_request.head.sha }}
                  path: test-repo

            - name: "Checkout automation-reports (${{ github.ref }}) - tested repo, push to main"
              if: github.event_name == 'push'
              uses: actions/checkout@v5
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  path: test-repo

            - name: "Checkout automation-reports (${{ github.ref }}) - main repo"
              uses: actions/checkout@v5
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  path: main-repo

            - name: "Set up Python"
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: "Install pip-tools"
              run: |
                  python -m pip install --upgrade pip
                  pip install pip-tools

            - name: "Sync requirements files"
              run: |
                  chmod +x main-repo/sync-requirements.sh
                  cd test-repo
                  ../main-repo/sync-requirements.sh

            - name: "Check for changes"
              id: changes
              run: |
                  cd test-repo
                  if ! git diff --quiet requirements-build.txt; then
                    echo "changed=true" >> $GITHUB_OUTPUT
                    echo "Requirements-build.txt has been updated"
                  else
                    echo "changed=false" >> $GITHUB_OUTPUT
                    echo "Requirements-build.txt is up to date"
                  fi

            - name: "Commit and push changes"
              if: steps.changes.outputs.changed == 'true' && github.event_name == 'push'
              run: |
                  cd test-repo
                  git config --local user.email "action@github.com"
                  git config --local user.name "GitHub Action"
                  git add requirements-build.txt
                  git commit -m "Auto-sync requirements-build.txt from requirements-pinned.txt"
                  git push

            - name: "Add PR comment for changes"
              if: steps.changes.outputs.changed == 'true' && github.event_name == 'pull_request_target'
              uses: actions/github-script@v7
              with:
                  script: |
                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: '**Requirements-build.txt needs to be updated**\n\nThe `requirements-pinned.txt` file has changed but `requirements-build.txt` is not in sync. Please run `make sync-requirements` locally and commit the updated requirements-build.txt file.'
                      })

            - name: "Fail if requirements out of sync in PR"
              if: steps.changes.outputs.changed == 'true' && github.event_name == 'pull_request_target'
              run: |
                  cd test-repo
                  echo "Requirements-build.txt is out of sync. Please run 'make sync-requirements' locally and commit the changes."
                  git diff requirements-build.txt
                  exit 1
